<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¹¼å…’åœ’åœ–æ›¸ç®¡ç†ç³»çµ± Pro</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root {
            --primary: #4CAF50;
            --secondary: #2196F3;
            --danger: #f44336;
            --dark: #333;
            --bg: #f4f7f6;
        }
        * { box-sizing: border-box; }
        body { font-family: "å¾®è»Ÿæ­£é»‘é«”", sans-serif; background-color: var(--bg); margin: 0; padding: 10px; }
        .container { max-width: 800px; margin: 10px auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        
        /* å°è¦½åˆ— */
        .nav { display: flex; gap: 8px; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 15px; }
        .nav button { flex: 1; background: #eee; border: none; padding: 12px; cursor: pointer; border-radius: 8px; font-weight: bold; }
        .nav button.active { background: var(--secondary); color: white; }

        .page { display: none; }
        .page.active { display: block; }

        /* ç›¸æ©Ÿå®¹å™¨ */
        #reader-wrapper { display: none; margin: 20px 0; text-align: center; }
        #reader { width: 100%; max-width: 450px; margin: 0 auto; border-radius: 12px; overflow: hidden; border: 5px solid #ccc; }

        /* æŒ‰éˆ•æ¨£å¼ */
        .action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 15px 0; }
        .btn-main { padding: 20px; border: none; border-radius: 10px; color: white; font-size: 1.2rem; font-weight: bold; cursor: pointer; transition: 0.2s; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 10px; }
        .btn-borrow { background-color: var(--primary); }
        .btn-return { background-color: var(--secondary); }
        .btn-add-book { background-color: var(--dark); grid-column: span 2; } /* ç®¡ç†é é¢çš„å¤§æŒ‰éˆ• */
        .btn-cancel { background-color: #666; width: 100%; margin-top: 15px; padding: 15px; border: none; border-radius: 10px; color: white; font-weight: bold; }

        .input-group { margin: 15px 0; display: flex; flex-direction: column; gap: 10px; }
        input, select { padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; }

        /* ç´€éŒ„èˆ‡åˆ—è¡¨ */
        .log-item { padding: 15px; margin-bottom: 8px; border-radius: 8px; background: #fff; border: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .table-container { overflow-x: auto; margin-top: 20px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid #eee; }

        @media (min-width: 600px) { .input-group { flex-direction: row; } }
    </style>
</head>
<body>

<div class="container">
    <div class="nav">
        <button onclick="changeTab('loanPage')" id="btn-loanPage" class="active">ğŸ“– å€Ÿé‚„æ›¸</button>
        <button onclick="changeTab('managePage')" id="btn-managePage">âš™ï¸ åœ–æ›¸ç®¡ç†</button>
        <button onclick="changeTab('reportPage')" id="btn-reportPage">ğŸ“Š å ±è¡¨</button>
    </div>

    <div id="loanPage" class="page active">
        <div class="input-group">
            <select id="borrowerUnit">
                <option value="class">ğŸ« ç­ç´š</option>
                <option value="family">ğŸ  å®¶åº­</option>
            </select>
            <input type="text" id="unitName" placeholder="è¼¸å…¥åç¨± (å¦‚: å°ç†Šç­)">
        </div>

        <div id="loanActionGrid" class="action-grid">
            <button onclick="initiateScan('borrow')" class="btn-main btn-borrow"><span>ğŸ“¤</span> å€Ÿæ›¸</button>
            <button onclick="initiateScan('return')" class="btn-main btn-return"><span>ğŸ“¥</span> é‚„æ›¸</button>
        </div>

        <div id="reader-wrapper">
            <h3 id="scanModeTitle">æº–å‚™æƒæ...</h3>
            <div id="reader"></div>
            <button onclick="stopScanner()" class="btn-cancel">âŒ å–æ¶ˆä¸¦è¿”å›</button>
        </div>

        <div id="logList" style="margin-top: 20px;"></div>
    </div>

    <div id="managePage" class="page">
        <div id="manageActionGrid" class="action-grid">
            <button onclick="initiateScan('add')" class="btn-main btn-add-book"><span>â•</span> æƒææ–°å¢åœ–æ›¸</button>
        </div>

        <div class="table-container">
            <h3>ç›®å‰é¤¨è—åˆ—è¡¨</h3>
            <table id="bookTable">
                <thead><tr><th>æ¢ç¢¼</th><th>æ›¸å</th><th>æ“ä½œ</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <div id="reportPage" class="page">
        <h3>ğŸ“Š å€Ÿé–±çµ±è¨ˆ</h3>
        <div class="table-container">
            <table id="statTable">
                <thead><tr><th>æ›¸å</th><th>ç‹€æ…‹</th><th>æ¬¡æ•¸</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    let bookDatabase = JSON.parse(localStorage.getItem('bookDB')) || {
        "123456": { title: "å¹¼å…’åœ’ç¹ªæœ¬ç¯„ä¾‹", count: 0, status: "åœ¨é¤¨" }
    };
    
    let html5QrCode;
    let currentMode = ''; 

    function initiateScan(mode) {
        if (mode !== 'add') {
            const unitName = document.getElementById('unitName').value.trim();
            if (!unitName) return alert("âš ï¸ è«‹å…ˆè¼¸å…¥åç¨±ï¼");
        }

        currentMode = mode;
        // éš±è—æ‰€æœ‰å‹•ä½œæŒ‰éˆ•
        document.getElementById('loanActionGrid').style.display = 'none';
        document.getElementById('manageActionGrid').style.display = 'none';
        
        // é¡¯ç¤ºæƒæå™¨ (å°‡æƒæå™¨ç§»è‡³ç•¶å‰é é¢å…§éƒ¨çš„ wrapper)
        const wrapper = document.getElementById('reader-wrapper');
        const activePage = document.querySelector('.page.active');
        activePage.insertBefore(wrapper, activePage.querySelector('.table-container') || activePage.querySelector('#logList'));
        wrapper.style.display = 'block';
        
        const modeTitle = document.getElementById('scanModeTitle');
        if(mode === 'borrow') modeTitle.innerHTML = `<span style="color:var(--primary)">ğŸ“¤ æ­£åœ¨å€Ÿæ›¸æƒæ...</span>`;
        else if(mode === 'return') modeTitle.innerHTML = `<span style="color:var(--secondary)">ğŸ“¥ æ­£åœ¨é‚„æ›¸æƒæ...</span>`;
        else modeTitle.innerHTML = `<span style="color:var(--dark)">â• æ­£åœ¨æ–°å¢åœ–æ›¸æƒæ...</span>`;

        startScanner();
    }

    function startScanner() {
        html5QrCode = new Html5Qrcode("reader");
        html5QrCode.start({ facingMode: "environment" }, { fps: 15, qrbox: 250 }, handleScanSuccess)
        .catch(err => { alert("ç›¸æ©Ÿå•Ÿå‹•å¤±æ•—"); stopScanner(); });
    }

    function handleScanSuccess(barcode) {
        if (currentMode === 'add') {
            stopScanner(); // æ–°å¢æ¨¡å¼å…ˆåœæ­¢æƒæä»¥ä¾¿è¼¸å…¥
            setTimeout(() => {
                const title = prompt(`ç™¼ç¾æ–°æ¢ç¢¼: ${barcode}\nè«‹è¼¸å…¥æ›¸å:`);
                if (title) {
                    bookDatabase[barcode] = { title, count: 0, status: "åœ¨é¤¨" };
                    saveData();
                    renderManageTable();
                    alert(`ã€Š${title}ã€‹å·²æˆåŠŸå…¥åº«ï¼`);
                }
            }, 500);
            return;
        }

        // å€Ÿé‚„æ¨¡å¼é‚è¼¯
        if (!bookDatabase[barcode]) {
            alert(`âŒ æ‰¾ä¸åˆ°æ­¤æ›¸ç±ï¼š${barcode}\nè«‹å…ˆè‡³ç®¡ç†é é¢æ–°å¢ã€‚`);
            stopScanner();
            return;
        }

        const book = bookDatabase[barcode];
        if (currentMode === 'borrow') {
            book.status = `å€Ÿå‡º (${document.getElementById('unitName').value})`;
            book.count++;
        } else {
            book.status = "åœ¨é¤¨";
        }

        addLogEntry(book.title, barcode);
        saveData();
        if (navigator.vibrate) navigator.vibrate(100);
        stopScanner();
    }

    function addLogEntry(title, barcode) {
        const logItem = document.createElement('div');
        logItem.className = 'log-item';
        const actionText = currentMode === 'borrow' ? 'å€Ÿå‡º' : 'æ­¸é‚„';
        const color = currentMode === 'borrow' ? 'var(--primary)' : 'var(--secondary)';
        logItem.innerHTML = `<div><b>${title}</b></div><div><span style="color:white; background:${color}; padding:2px 8px; border-radius:4px;">${actionText}</span></div>`;
        const logList = document.getElementById('logList');
        logList.insertBefore(logItem, logList.firstChild);
    }

    function stopScanner() {
        if (html5QrCode) {
            html5QrCode.stop().then(() => {
                html5QrCode = null;
                document.getElementById('reader-wrapper').style.display = 'none';
                document.getElementById('loanActionGrid').style.display = 'grid';
                document.getElementById('manageActionGrid').style.display = 'grid';
            });
        }
    }

    function changeTab(pageId) {
        if (html5QrCode) stopScanner();
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.nav button').forEach(b => b.classList.remove('active'));
        document.getElementById(pageId).classList.add('active');
        document.getElementById('btn-' + pageId).classList.add('active');
        if(pageId === 'managePage') renderManageTable();
        if(pageId === 'reportPage') renderReportTable();
    }

    function renderManageTable() {
        const tbody = document.querySelector('#bookTable tbody');
        tbody.innerHTML = Object.keys(bookDatabase).map(isbn => `
            <tr><td>${isbn}</td><td>${bookDatabase[isbn].title}</td><td><button onclick="deleteBook('${isbn}')" style="color:red; border:none; background:none; cursor:pointer;">å ±å»¢</button></td></tr>
        `).join('');
    }

    function renderReportTable() {
        const tbody = document.querySelector('#statTable tbody');
        tbody.innerHTML = Object.keys(bookDatabase).map(isbn => `
            <tr><td>${bookDatabase[isbn].title}</td><td>${bookDatabase[isbn].status}</td><td>${bookDatabase[isbn].count}</td></tr>
        `).join('');
    }

    function deleteBook(isbn) {
        if(confirm('ç¢ºå®šå ±å»¢ï¼Ÿ')) { delete bookDatabase[isbn]; saveData(); renderManageTable(); }
    }

    function saveData() { localStorage.setItem('bookDB', JSON.stringify(bookDatabase)); }
    
    // åˆå§‹åŒ–è¡¨æ ¼
    renderManageTable();
</script>

</body>
</html>