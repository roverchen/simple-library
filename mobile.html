<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¹¼å…’åœ’åœ–æ›¸ç®¡ç†ç³»çµ± Pro</title>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        :root {
            --primary: #4CAF50;
            --secondary: #2196F3;
            --danger: #f44336;
            --dark: #333;
            --bg: #f4f7f6;
        }
        * { box-sizing: border-box; }
        body { font-family: "å¾®è»Ÿæ­£é»‘é«”", sans-serif; background-color: var(--bg); margin: 0; padding: 10px; }
        .container { max-width: 800px; margin: 10px auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        
        /* å°è¦½åˆ— */
        .nav { display: flex; gap: 8px; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 15px; }
        .nav button { flex: 1; background: #eee; border: none; padding: 12px; cursor: pointer; border-radius: 8px; font-weight: bold; }
        .nav button.active { background: var(--secondary); color: white; }

        .page { display: none; }
        .page.active { display: block; }

        /* ç›¸æ©Ÿå®¹å™¨ */
        #reader-wrapper { display: none; margin: 20px 0; text-align: center; }
        #reader { width: 100%; max-width: 450px; margin: 0 auto; border-radius: 12px; overflow: hidden; border: 5px solid #ccc; }

        /* æŒ‰éˆ•æ¨£å¼ */
        .action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 15px 0; }
        .btn-main { padding: 20px; border: none; border-radius: 10px; color: white; font-size: 1.2rem; font-weight: bold; cursor: pointer; transition: 0.2s; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 10px; text-decoration: none; }
        .btn-borrow { background-color: var(--primary); }
        .btn-return { background-color: var(--secondary); }
        .btn-add-book { background-color: var(--dark); grid-column: span 2; }
        .btn-cancel { background-color: #666; width: 100%; margin-top: 15px; padding: 15px; border: none; border-radius: 10px; color: white; font-weight: bold; }

        .input-group { margin: 15px 0; display: flex; flex-direction: column; gap: 10px; }
        input, select { padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; }

        /* ç´€éŒ„èˆ‡åˆ—è¡¨ */
        .log-item { padding: 15px; margin-bottom: 8px; border-radius: 8px; background: #fff; border: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        
        /* è¡¨æ ¼å„ªåŒ– */
        .table-container { overflow-x: auto; margin-top: 20px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid #eee; }
        .btn-edit { color: var(--secondary); border: 1px solid var(--secondary); background: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; margin-right: 5px; }
        .btn-del { color: var(--danger); border: 1px solid var(--danger); background: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; }

        @media (min-width: 600px) { .input-group { flex-direction: row; } }
    </style>
</head>
<body>

<div class="container">
    <div class="nav">
        <button onclick="changeTab('loanPage')" id="btn-loanPage" class="active">ğŸ“– å€Ÿé‚„æ›¸</button>
        <button onclick="changeTab('managePage')" id="btn-managePage">âš™ï¸ åœ–æ›¸ç®¡ç†</button>
        <button onclick="changeTab('reportPage')" id="btn-reportPage">ğŸ“Š å ±è¡¨</button>
    </div>

    <div id="loanPage" class="page active">
        <div class="input-group">
            <select id="borrowerUnit">
                <option value="class">ğŸ« ç­ç´š</option>
                <option value="family">ğŸ  å®¶åº­</option>
            </select>
            <input type="text" id="unitName" placeholder="è¼¸å…¥åç¨± (å¦‚: å°ç†Šç­)">
        </div>

        <div id="loanActionGrid" class="action-grid">
            <button onclick="initiateScan('borrow')" class="btn-main btn-borrow"><span>ğŸ“¤</span> å€Ÿæ›¸</button>
            <button onclick="initiateScan('return')" class="btn-main btn-return"><span>ğŸ“¥</span> é‚„æ›¸</button>
        </div>

        <div id="reader-wrapper">
            <h3 id="scanModeTitle">æº–å‚™æƒæ...</h3>
            <div id="reader"></div>
            <button onclick="stopScanner()" class="btn-cancel">âŒ å–æ¶ˆä¸¦è¿”å›</button>
        </div>

        <div id="logList" style="margin-top: 20px;"></div>
    </div>

    <div id="managePage" class="page">
        <div id="manageActionGrid" class="action-grid">
            <button onclick="initiateScan('manage')" class="btn-main btn-add-book"><span>ğŸ”</span> æƒææ–°å¢/ä¿®æ”¹åœ–æ›¸</button>
        </div>

        <div class="table-container">
            <h3>ç›®å‰é¤¨è—åˆ—è¡¨</h3>
            <table id="bookTable">
                <thead><tr><th>æ›¸å</th><th style="text-align:right;">ç®¡ç†æ“ä½œ</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <div id="reportPage" class="page">
        <h3>ğŸ“Š å€Ÿé–±çµ±è¨ˆ</h3>
        <div class="table-container">
            <table id="statTable">
                <thead><tr><th>æ›¸å</th><th>ç‹€æ…‹</th><th>æ¬¡æ•¸</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    let bookDatabase = JSON.parse(localStorage.getItem('bookDB')) || {
        "123456": { title: "å¹¼å…’åœ’ç¹ªæœ¬ç¯„ä¾‹", count: 0, status: "åœ¨é¤¨" }
    };
    
    let html5QrCode;
    let currentMode = ''; 

    function initiateScan(mode) {
        if (mode !== 'manage') {
            const unitName = document.getElementById('unitName').value.trim();
            if (!unitName) return alert("âš ï¸ è«‹å…ˆè¼¸å…¥å–®ä½åç¨±ï¼");
        }

        currentMode = mode;
        document.getElementById('loanActionGrid').style.display = 'none';
        document.getElementById('manageActionGrid').style.display = 'none';
        
        const wrapper = document.getElementById('reader-wrapper');
        const activePage = document.querySelector('.page.active');
        activePage.insertBefore(wrapper, activePage.querySelector('.table-container') || activePage.querySelector('#logList'));
        wrapper.style.display = 'block';
        
        const modeTitle = document.getElementById('scanModeTitle');
        if(mode === 'borrow') modeTitle.innerHTML = `<span style="color:var(--primary)">ğŸ“¤ æ­£åœ¨å€Ÿæ›¸æƒæ...</span>`;
        else if(mode === 'return') modeTitle.innerHTML = `<span style="color:var(--secondary)">ğŸ“¥ æ­£åœ¨é‚„æ›¸æƒæ...</span>`;
        else modeTitle.innerHTML = `<span style="color:var(--dark)">ğŸ” æƒææ¢ç¢¼ä»¥æ–°å¢æˆ–ä¿®æ”¹...</span>`;

        startScanner();
    }

    function startScanner() {
        html5QrCode = new Html5Qrcode("reader");
    
        const config = { 
            fps: 20, 
            // qrbox è¨­ç‚ºé•·æ–¹å½¢æ›´é©åˆ ISBN
            qrbox: { width: 300, height: 120 }, 
            // å¢åŠ æ­¤åƒæ•¸ï¼šå¼·åˆ¶å˜—è©¦è§£è®€å¤šç¨®æ ¼å¼ï¼ˆç‰¹åˆ¥æ˜¯ä¸€ç¶­æ¢ç¢¼ï¼‰
            formatsToSupport: [ 
                Html5QrcodeSupportedFormats.EAN_13, 
                Html5QrcodeSupportedFormats.EAN_8,
                Html5QrcodeSupportedFormats.CODE_128 
            ]
        };

        html5QrCode.start(
            { facingMode: "environment" }, 
            config, 
            handleScanSuccess
        ).catch(err => { 
            alert("ç›¸æ©Ÿå•Ÿå‹•å¤±æ•—"); 
            stopScanner(); 
        });
    }
/*    
    function startScanner() {
        html5QrCode = new Html5Qrcode("reader");
    
        const config = { 
            fps: 20,                       
            qrbox: { width: 280, height: 160 }, 
            aspectRatio: 1.0               
        };

        html5QrCode.start(
            { facingMode: "environment" }, 
            config, 
            handleScanSuccess
        ).catch(err => { 
            alert("ç›¸æ©Ÿå•Ÿå‹•å¤±æ•—ï¼Œè«‹ç¢ºèªæ¬Šé™æˆ–å˜—è©¦é‡æ–°æ•´ç†ã€‚"); 
            stopScanner(); 
        });
    }
*/
    function handleScanSuccess(barcode) {
        if (currentMode === 'manage') {
            stopScanner();
            setTimeout(() => {
                const existingTitle = bookDatabase[barcode] ? bookDatabase[barcode].title : "";
                const promptMsg = existingTitle ? `é€™æœ¬æ›¸æ¢ç¢¼ç‚º: ${barcode}\nç›®å‰åç¨±: ${existingTitle}\nè«‹è¼¸å…¥æ–°çš„æ›¸å:` : `ç™¼ç¾æ–°æ¢ç¢¼: ${barcode}\nè«‹è¼¸å…¥æ›¸å:`;
                
                const title = prompt(promptMsg, existingTitle);
                if (title !== null && title.trim() !== "") {
                    bookDatabase[barcode] = { 
                        title: title.trim(), 
                        count: bookDatabase[barcode] ? bookDatabase[barcode].count : 0, 
                        status: bookDatabase[barcode] ? bookDatabase[barcode].status : "åœ¨é¤¨" 
                    };
                    saveData();
                    renderManageTable();
                    // ç§»é™¤ alert("è³‡æ–™å·²æ›´æ–°ï¼");
                }
            }, 500);
            return;
        }

        if (!bookDatabase[barcode]) {
            alert(`âŒ æ‰¾ä¸åˆ°æ­¤æ›¸ç±ï¼š${barcode}\nè«‹è‡³ç®¡ç†é é¢æƒæå…¥åº«ã€‚`);
            stopScanner();
            return;
        }

        const book = bookDatabase[barcode];
        if (currentMode === 'borrow') {
            book.status = `å€Ÿå‡º (${document.getElementById('unitName').value})`;
            book.count++;
        } else {
            book.status = "åœ¨é¤¨";
        }

        addLogEntry(book.title, barcode);
        saveData();
        if (navigator.vibrate) navigator.vibrate(100);
        stopScanner();
    }

    function addLogEntry(title, barcode) {
        const logItem = document.createElement('div');
        logItem.className = 'log-item';
        const actionText = currentMode === 'borrow' ? 'å€Ÿå‡º' : 'æ­¸é‚„';
        const color = currentMode === 'borrow' ? 'var(--primary)' : 'var(--secondary)';
        logItem.innerHTML = `<div><b>${title}</b></div><div><span style="color:white; background:${color}; padding:2px 8px; border-radius:4px;">${actionText}</span></div>`;
        const logList = document.getElementById('logList');
        logList.insertBefore(logItem, logList.firstChild);
    }

    function stopScanner() {
        if (html5QrCode) {
            html5QrCode.stop().then(() => {
                html5QrCode = null;
                document.getElementById('reader-wrapper').style.display = 'none';
                document.getElementById('loanActionGrid').style.display = 'grid';
                document.getElementById('manageActionGrid').style.display = 'grid';
            });
        }
    }

    function changeTab(pageId) {
        if (html5QrCode) stopScanner();
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.nav button').forEach(b => b.classList.remove('active'));
        document.getElementById(pageId).classList.add('active');
        document.getElementById('btn-' + pageId).classList.add('active');
        if(pageId === 'managePage') renderManageTable();
        if(pageId === 'reportPage') renderReportTable();
    }

    function renderManageTable() {
        const tbody = document.querySelector('#bookTable tbody');
        tbody.innerHTML = Object.keys(bookDatabase).map(isbn => `
            <tr>
                <td><b>${bookDatabase[isbn].title}</b></td>
                <td style="text-align:right;">
                    <button onclick="manualEdit('${isbn}')" class="btn-edit">ä¿®æ”¹</button>
                    <button onclick="deleteBook('${isbn}')" class="btn-del">å ±å»¢</button>
                </td>
            </tr>
        `).join('');
    }

    function manualEdit(isbn) {
        const newTitle = prompt("ä¿®æ”¹æ›¸å:", bookDatabase[isbn].title);
        if (newTitle !== null && newTitle.trim() !== "") {
            bookDatabase[isbn].title = newTitle.trim();
            saveData();
            renderManageTable();
            // æ­¤è™•åŒæ¨£ä¸é¡¯ç¤º alert
        }
    }

    function renderReportTable() {
        const tbody = document.querySelector('#statTable tbody');
        tbody.innerHTML = Object.keys(bookDatabase).map(isbn => `
            <tr><td>${bookDatabase[isbn].title}</td><td>${bookDatabase[isbn].status}</td><td>${bookDatabase[isbn].count}æ¬¡</td></tr>
        `).join('');
    }

    function deleteBook(isbn) {
        if(confirm(`ç¢ºå®šå ±å»¢ã€Š${bookDatabase[isbn].title}ã€‹ï¼Ÿ`)) { 
            delete bookDatabase[isbn]; 
            saveData(); 
            renderManageTable(); 
        }
    }

    function saveData() { localStorage.setItem('bookDB', JSON.stringify(bookDatabase)); }
    
    renderManageTable();
</script>

</body>
</html>