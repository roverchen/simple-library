<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¹¼å…’åœ’åœ–æ›¸ç®¡ç†ç³»çµ± (æƒæè‡ªå‹•é—œé–‰ç‰ˆ)</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root {
            --primary: #4CAF50;
            --secondary: #2196F3;
            --danger: #f44336;
            --dark: #333;
            --bg: #f4f7f6;
        }
        * { box-sizing: border-box; }
        body { font-family: "å¾®è»Ÿæ­£é»‘é«”", sans-serif; background-color: var(--bg); margin: 0; padding: 10px; }
        .container { max-width: 800px; margin: 10px auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        
        .nav { display: flex; gap: 8px; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 15px; }
        .nav button { flex: 1; background: #eee; border: none; padding: 12px; cursor: pointer; border-radius: 8px; font-weight: bold; }
        .nav button.active { background: var(--secondary); color: white; }

        .page { display: none; }
        .page.active { display: block; }

        /* ç›¸æ©Ÿé è¦½å®¹å™¨ */
        #reader-wrapper { 
            display: none; 
            margin: 20px 0; 
            text-align: center;
        }
        #reader { 
            width: 100%; 
            max-width: 450px; 
            margin: 0 auto; 
            border-radius: 12px; 
            overflow: hidden;
            border: 5px solid #ccc;
        }

        .action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 15px 0; }
        .btn-scan { padding: 18px; border: none; border-radius: 10px; color: white; font-size: 1.1rem; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-borrow { background-color: var(--primary); }
        .btn-return { background-color: var(--secondary); }
        .btn-stop { background-color: #666; width: 100%; margin-top: 15px; }

        .input-group { margin: 15px 0; display: flex; flex-direction: column; gap: 10px; }
        input, select { padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; }

        .log-item { 
            padding: 15px; 
            margin-bottom: 8px;
            border-radius: 8px;
            background: #fff;
            border: 1px solid #eee;
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
        }
        .status-tag { padding: 4px 10px; border-radius: 4px; font-size: 0.85rem; color: white; font-weight: bold; }

        /* ç®¡ç†è¡¨æ ¼ */
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid #eee; }
        th { background: #f8f8f8; }

        @media (min-width: 600px) {
            .input-group { flex-direction: row; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="nav">
        <button onclick="changeTab('loanPage')" id="btn-loanPage" class="active">ğŸ“– å€Ÿé‚„æ›¸</button>
        <button onclick="changeTab('managePage')" id="btn-managePage">âš™ï¸ ç®¡ç†</button>
        <button onclick="changeTab('reportPage')" id="btn-reportPage">ğŸ“Š å ±è¡¨</button>
    </div>

    <div id="loanPage" class="page active">
        <div class="input-group">
            <select id="borrowerUnit">
                <option value="class">ğŸ« ç­ç´š</option>
                <option value="family">ğŸ  å®¶åº­</option>
            </select>
            <input type="text" id="unitName" placeholder="è¼¸å…¥åç¨± (å¦‚: å°ç†Šç­)">
        </div>

        <div id="actionGrid" class="action-grid">
            <button onclick="initiateScan('borrow')" class="btn-scan btn-borrow">ğŸ“¤ å€Ÿæ›¸æƒæ</button>
            <button onclick="initiateScan('return')" class="btn-scan btn-return">ğŸ“¥ é‚„æ›¸æƒæ</button>
        </div>

        <div id="reader-wrapper">
            <h3 id="scanModeTitle">æº–å‚™æƒæ...</h3>
            <div id="reader"></div>
            <button onclick="stopScanner()" class="btn-scan btn-stop">âŒ å–æ¶ˆæƒæ</button>
        </div>

        <h3 style="margin-top:25px; border-left: 5px solid var(--secondary); padding-left: 10px; font-size: 1.1rem;">æœ€è¿‘å€Ÿé‚„ç´€éŒ„</h3>
        <div id="logList"></div>
    </div>

    <div id="managePage" class="page">
        <h3>âš™ï¸ åœ–æ›¸è³‡æ–™æ–°å¢</h3>
        <div class="input-group" style="background: #f9f9f9; padding: 15px; border-radius: 8px; border: 1px solid #eee;">
            <input type="text" id="newIsbn" placeholder="æ¢ç¢¼ç·¨è™Ÿ">
            <input type="text" id="newTitle" placeholder="æ›¸å">
            <button onclick="addBook()" style="background:var(--primary); color:white; border:none; padding:12px; border-radius:8px; cursor:pointer;">ç¢ºèªæ–°å¢</button>
        </div>
        <div class="table-container">
            <table id="bookTable">
                <thead><tr><th>æ¢ç¢¼</th><th>æ›¸å</th><th>æ“ä½œ</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <div id="reportPage" class="page">
        <h3>ğŸ“Š å€Ÿé–±çµ±è¨ˆå ±è¡¨</h3>
        <div class="table-container">
            <table id="statTable">
                <thead><tr><th>æ›¸å</th><th>ç›®å‰ç‹€æ…‹</th><th>å€Ÿé–±æ¬¡æ•¸</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // è³‡æ–™åˆå§‹åŒ–
    let bookDatabase = JSON.parse(localStorage.getItem('bookDB')) || {
        "123456": { title: "å¹¼å…’åœ’ç¹ªæœ¬ç¯„ä¾‹", count: 0, status: "åœ¨é¤¨" }
    };
    
    let html5QrCode;
    let currentMode = ''; 

    // å•Ÿå‹•ç›¸æ©Ÿ
    function initiateScan(mode) {
        const unitName = document.getElementById('unitName').value.trim();
        if (!unitName) {
            alert("âš ï¸ è«‹å…ˆè¼¸å…¥ã€å€Ÿé–±å–®ä½åç¨±ã€ï¼");
            return;
        }

        currentMode = mode;
        // åˆ‡æ› UI é¡¯ç¤º
        document.getElementById('actionGrid').style.display = 'none';
        document.getElementById('reader-wrapper').style.display = 'block';
        
        const modeTitle = document.getElementById('scanModeTitle');
        const readerElem = document.getElementById('reader');
        
        if (mode === 'borrow') {
            modeTitle.innerHTML = `<span style="color:var(--primary)">ğŸ“¤ å€Ÿæ›¸æ¨¡å¼ï¼šè«‹æƒææ›¸ç±æ¢ç¢¼</span>`;
            readerElem.style.borderColor = "var(--primary)";
        } else {
            modeTitle.innerHTML = `<span style="color:var(--secondary)">ğŸ“¥ é‚„æ›¸æ¨¡å¼ï¼šè«‹æƒææ›¸ç±æ¢ç¢¼</span>`;
            readerElem.style.borderColor = "var(--secondary)";
        }

        startScanner();
    }

    function startScanner() {
        html5QrCode = new Html5Qrcode("reader");
        const config = { fps: 15, qrbox: { width: 250, height: 180 } };

        html5QrCode.start(
            { facingMode: "environment" }, 
            config, 
            (decodedText) => {
                handleScanSuccess(decodedText);
            }
        ).catch(err => {
            alert("ç„¡æ³•å•Ÿå‹•ç›¸æ©Ÿã€‚è«‹ç¢ºèªï¼š\n1. å·²æˆäºˆç›¸æ©Ÿæ¬Šé™\n2. ç¶²å€ç‚º https æˆ– localhost");
            stopScanner();
        });
    }

    // é—œéµä¿®æ”¹ï¼šæƒææˆåŠŸè™•ç†é‚è¼¯
    function handleScanSuccess(barcode) {
        if (!bookDatabase[barcode]) {
            alert(`âŒ æ‰¾ä¸åˆ°æ­¤æ¢ç¢¼ï¼š${barcode}\nè«‹å…ˆè‡³ç®¡ç†é é¢æ‰‹å‹•æ–°å¢ã€‚`);
            return;
        }

        const book = bookDatabase[barcode];
        const unitName = document.getElementById('unitName').value;
        const timestamp = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

        // åŸ·è¡Œå€Ÿé‚„é‚è¼¯
        if (currentMode === 'borrow') {
            book.status = `å€Ÿå‡º (${unitName})`;
            book.count++;
        } else {
            book.status = "åœ¨é¤¨";
        }

        // æ–°å¢ UI ç´€éŒ„
        addLogEntry(book.title, barcode, timestamp);
        
        // å„²å­˜è³‡æ–™
        saveData();

        // éœ‡å‹•å›é¥‹ (æ‰‹æ©Ÿ)
        if (navigator.vibrate) navigator.vibrate(100);

        // ã€è‡ªå‹•é—œé–‰ç›¸æ©Ÿã€‘è¿”å›ä¸»ç•«é¢
        stopScanner();
    }

    function addLogEntry(title, barcode, time) {
        const logItem = document.createElement('div');
        logItem.className = 'log-item';
        const color = currentMode === 'borrow' ? 'var(--primary)' : 'var(--secondary)';
        const actionLabel = currentMode === 'borrow' ? 'å€Ÿå‡º' : 'æ­¸é‚„';
        
        logItem.innerHTML = `
            <div>
                <div style="font-weight:bold;">${title}</div>
                <div style="font-size:0.8rem; color:#888;">ID: ${barcode}</div>
            </div>
            <div style="text-align:right;">
                <span class="status-tag" style="background:${color}">${actionLabel}</span>
                <div style="font-size:0.75rem; color:#aaa; margin-top:5px;">${time}</div>
            </div>
        `;
        const logList = document.getElementById('logList');
        logList.insertBefore(logItem, logList.firstChild);
    }

    function stopScanner() {
        if (html5QrCode) {
            html5QrCode.stop().then(() => {
                html5QrCode = null;
                document.getElementById('reader-wrapper').style.display = 'none';
                document.getElementById('actionGrid').style.display = 'grid';
            }).catch(err => {
                console.error("åœæ­¢ç›¸æ©Ÿå¤±æ•—", err);
                // å¼·åˆ¶é—œé–‰ UI
                document.getElementById('reader-wrapper').style.display = 'none';
                document.getElementById('actionGrid').style.display = 'grid';
            });
        }
    }

    // --- åŸºç¤æ¡†æ¶èˆ‡æ•¸æ“šç®¡ç† ---
    function changeTab(pageId) {
        if (html5QrCode) stopScanner();
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.nav button').forEach(b => b.classList.remove('active'));
        document.getElementById(pageId).classList.add('active');
        document.getElementById('btn-' + pageId).classList.add('active');
        if(pageId === 'managePage') renderManageTable();
        if(pageId === 'reportPage') renderReportTable();
    }

    function addBook() {
        const isbn = document.getElementById('newIsbn').value.trim();
        const title = document.getElementById('newTitle').value.trim();
        if (isbn && title) {
            bookDatabase[isbn] = { title, count: 0, status: "åœ¨é¤¨" };
            saveData();
            renderManageTable();
            document.getElementById('newIsbn').value = '';
            document.getElementById('newTitle').value = '';
            alert("æ›¸ç±å·²æ–°å¢ï¼");
        }
    }

    function deleteBook(isbn) {
        if(confirm(`ç¢ºå®šå ±å»¢ã€Š${bookDatabase[isbn].title}ã€‹ï¼Ÿ`)) { 
            delete bookDatabase[isbn]; 
            saveData(); 
            renderManageTable(); 
        }
    }

    function renderManageTable() {
        const tbody = document.querySelector('#bookTable tbody');
        tbody.innerHTML = Object.keys(bookDatabase).map(isbn => `
            <tr>
                <td>${isbn}</td>
                <td><b>${bookDatabase[isbn].title}</b></td>
                <td><button onclick="deleteBook('${isbn}')" style="color:var(--danger); border:none; background:none; cursor:pointer;">å ±å»¢</button></td>
            </tr>
        `).join('');
    }

    function renderReportTable() {
        const tbody = document.querySelector('#statTable tbody');
        tbody.innerHTML = Object.keys(bookDatabase).map(isbn => `
            <tr>
                <td>${bookDatabase[isbn].title}</td>
                <td><span style="color:${bookDatabase[isbn].status === 'åœ¨é¤¨' ? 'green' : 'orange'}">${bookDatabase[isbn].status}</span></td>
                <td>${bookDatabase[isbn].count}æ¬¡</td>
            </tr>
        `).join('');
    }

    function saveData() {
        localStorage.setItem('bookDB', JSON.stringify(bookDatabase));
    }
</script>

</body>
</html>