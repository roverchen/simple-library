<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¹¼å…’åœ’åœ–æ›¸è³‡è¨Šç®¡ç†ç³»çµ± Pro (QRç‰ˆ)</title>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root {
            --primary: #4CAF50;
            --secondary: #2196F3;
            --danger: #f44336;
            --dark: #333;
            --bg: #f4f7f6;
        }
        * { box-sizing: border-box; }
        body { font-family: "å¾®è»Ÿæ­£é»‘é«”", sans-serif; background-color: var(--bg); margin: 0; padding: 10px; }
        .container { max-width: 900px; margin: 10px auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        
        /* å°è¦½åˆ— */
        .nav { display: none; gap: 5px; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 10px; flex-wrap: wrap; }
        .nav button { flex: 1; min-width: 80px; background: #eee; border: none; padding: 12px 5px; cursor: pointer; border-radius: 8px; font-weight: bold; }
        .nav button.active { background: var(--secondary); color: white; }

        .page { display: none; }
        .page.active { display: block; }

        /* ç›¸æ©Ÿå®¹å™¨ */
        #reader-wrapper { display: none; margin: 20px 0; text-align: center; }
        #reader { width: 100%; max-width: 550px; margin: 0 auto; border-radius: 12px; overflow: hidden; border: 5px solid #ccc; }

        /* æ“ä½œä»‹é¢ */
        .action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 15px 0; }
        .btn-main { padding: 20px; border: none; border-radius: 10px; color: white; font-size: 1.1rem; font-weight: bold; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 8px; }
        .btn-borrow { background-color: var(--primary); }
        .btn-return { background-color: var(--secondary); }
        .btn-add-book { background-color: var(--dark); grid-column: span 2; }

        .input-group { margin: 10px 0; display: flex; flex-direction: column; gap: 8px; }
        input, select { padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; width: 100%; }

        table { width: 100%; border-collapse: collapse; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid #eee; }

        @media print {
            .nav, .btn-main, #reader-wrapper, .input-group, .no-print, .btn-del { display: none !important; }
            .container { box-shadow: none; border: none; width: 100%; max-width: none; }
        }
    </style>
</head>
<body>

<div class="container">
    <div id="loginPage" class="page active">
        <div style="text-align: center; max-width: 350px; margin: auto;">
            <h2>ğŸ” å¹¼å…’åœ’åœ–æ›¸ç³»çµ±</h2>
            <input type="password" id="loginPwd" placeholder="è«‹è¼¸å…¥ç®¡ç†å¯†ç¢¼" style="margin-bottom:15px; padding:12px; width:100%; border-radius:8px; border:1px solid #ddd;">
            <button onclick="handleLogin()" class="btn-main btn-return" style="width: 100%; padding: 15px;">ç™»å…¥ç³»çµ±</button>
        </div>
    </div>

    <div class="nav no-print" id="mainNav">
        <button onclick="changeTab('loanPage')" id="btn-loanPage">å€Ÿé‚„æ›¸</button>
        <button onclick="changeTab('classPage')" id="btn-classPage">ç­ç´šæˆå“¡</button>
        <button onclick="changeTab('managePage')" id="btn-managePage">åœ–æ›¸ç®¡ç†</button>
        <button onclick="changeTab('configPage')" id="btn-configPage">ç³»çµ±è¨­å®š</button>
        <button onclick="changeTab('reportPage')" id="btn-reportPage">å ±è¡¨</button>
        <button onclick="handleLogout()" style="background:#666; color:white;">ç™»å‡º</button>
    </div>

    <div id="loanPage" class="page">
        <div class="input-group">
            <select id="loanClass" onchange="filterMembers('loanMember', this.value)"></select>
            <select id="loanMember"></select>
        </div>
        <div id="loanActionGrid" class="action-grid">
            <button onclick="initiateScan('borrow')" class="btn-main btn-borrow">ğŸ“¤ å€Ÿæ›¸</button>
            <button onclick="initiateScan('return')" class="btn-main btn-return">ğŸ“¥ é‚„æ›¸</button>
        </div>
        <div id="reader-wrapper">
            <h3 id="scanModeTitle">æº–å‚™æƒæ QR Code...</h3>
            <div id="reader"></div>
            <button onclick="stopScanner()" style="width:100%; padding:15px; margin-top:10px; border-radius:8px; border:none; background:#666; color:white;">âŒ å–æ¶ˆ</button>
        </div>
        <div id="logList"></div>
    </div>

    <div id="classPage" class="page">
        <h3>ğŸ‘¥ ç­ç´šæˆå“¡åå–®</h3>
        <div class="input-group">
            <select id="editClassSelect"></select>
            <input type="text" id="newMemberName" placeholder="è¼¸å…¥å¹¼å…’æˆ–è€å¸«å§“å">
            <button onclick="addMember()" class="btn-main btn-borrow" style="width:100%; padding:10px;">æ–°å¢æˆå“¡</button>
        </div>
        <table id="memberTable">
            <thead><tr><th>ç­ç´š</th><th>å§“å</th><th>æ“ä½œ</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>

    <div id="managePage" class="page">
        <div id="manageActionGrid" class="action-grid">
            <button onclick="initiateScan('manage')" class="btn-main btn-add-book">ğŸ” æƒææ–°å¢/ä¿®æ”¹åœ–æ›¸ (QR)</button>
        </div>
        <table id="bookTable">
            <thead><tr><th>æ›¸å</th><th>è²¡ç”¢ç·¨è™Ÿ</th><th>ç®¡ç†</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>

    <div id="configPage" class="page">
        <h3>âš™ï¸ ç³»çµ±é€²éšè¨­å®š</h3>
        <div class="input-group" style="background:#fff3e0; padding:15px; border-radius:8px;">
            <label>ğŸ”‘ ä¿®æ”¹å¯†ç¢¼</label>
            <input type="text" id="newSystemPwd" placeholder="è¼¸å…¥æ–°å¯†ç¢¼">
            <button onclick="updatePassword()" style="background:var(--dark); color:white; border:none; padding:10px; border-radius:5px;">æ›´æ–°</button>
        </div>
        <div class="input-group">
            <label>ğŸ« ç­ç´šæ¸…å–® (é€—è™Ÿéš”é–‹)</label>
            <input type="text" id="classListInput">
            <button onclick="updateClassList()" style="background:var(--secondary); color:white; border:none; padding:10px; border-radius:5px;">æ›´æ–°</button>
        </div>
    </div>

    <div id="reportPage" class="page">
        <button onclick="window.print()" class="no-print" style="padding:10px; background:#607d8b; color:white;">ğŸ–¨ï¸ åˆ—å°å ±è¡¨</button>
        <table id="reportTable">
            <thead><tr><th>æ™‚é–“</th><th>ç­ç´š</th><th>å§“å</th><th>æ›¸å</th><th>ç‹€æ…‹</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<script>
    // --- æ ¸å¿ƒè³‡æ–™å„²å­˜ ---
    let config = JSON.parse(localStorage.getItem('libConfig')) || {
        password: "1234",
        classes: ["å¤ªé™½ç­", "æœˆäº®ç­", "æ˜Ÿæ˜Ÿç­", "å½©è™¹ç­", "ç™½é›²ç­", "å°è‰ç­"]
    };
    let members = JSON.parse(localStorage.getItem('memberDB')) || {}; 
    let bookDatabase = JSON.parse(localStorage.getItem('bookDB')) || {};
    let loanLogs = JSON.parse(localStorage.getItem('loanLogs')) || [];
    
    let html5QrCode;
    let currentMode = '';

    // --- 1. ç™»å…¥é‚è¼¯ ---
    function handleLogin() {
        if(document.getElementById('loginPwd').value === config.password) {
            document.getElementById('loginPage').classList.remove('active');
            document.getElementById('mainNav').style.display = 'flex';
            initDropdowns();
            changeTab('loanPage');
        } else { alert("å¯†ç¢¼éŒ¯èª¤"); }
    }

    // --- 2. åˆ†é èˆ‡é¸å–®é‚è¼¯ ---
    function changeTab(pageId) {
        if (html5QrCode) stopScanner();
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.nav button').forEach(b => b.classList.remove('active'));
        document.getElementById(pageId).classList.add('active');
        document.getElementById('btn-' + pageId).classList.add('active');
        
        if(pageId === 'classPage') renderMemberTable();
        if(pageId === 'managePage') renderBookTable();
        if(pageId === 'reportPage') renderReportTable();
    }

    function initDropdowns() {
        const selects = ['loanClass', 'editClassSelect'];
        selects.forEach(id => {
            const el = document.getElementById(id);
            if(el) el.innerHTML = config.classes.map(c => `<option value="${c}">${c}</option>`).join('');
        });
        document.getElementById('classListInput').value = config.classes.join(',');
        filterMembers('loanMember', config.classes[0]);
    }

    function filterMembers(targetId, className) {
        const el = document.getElementById(targetId);
        const list = members[className] || [];
        el.innerHTML = list.length ? list.map(m => `<option value="${m}">${m}</option>`).join('') : '<option value="">(ç„¡æˆå“¡)</option>';
    }

    // --- 3. æƒææ ¸å¿ƒåŠŸèƒ½ ---
    function initiateScan(mode) {
        // 1. æ¬Šé™æª¢æŸ¥
        if (mode !== 'manage') {
            const member = document.getElementById('loanMember').value;
            if (!member || member === "(ç„¡æˆå“¡)") {
                alert("âš ï¸ è«‹å…ˆé¸æ“‡å€Ÿé–±äººï¼");
                return;
            }
        }

        currentMode = mode;

        // 2. UI åˆ‡æ›
        document.getElementById('loanActionGrid').style.display = 'none';
        document.getElementById('manageActionGrid').style.display = 'none';
    
    // 3. ã€é—œéµä¿®æ­£ã€‘å°‡æƒæå®¹å™¨ç§»å‹•åˆ°ç›®å‰çš„æ´»èºé é¢
    const wrapper = document.getElementById('reader-wrapper');
    const activePage = document.querySelector('.page.active');
    
    // å°‹æ‰¾è©²é é¢é©åˆæ’å…¥çš„ä½ç½®ï¼ˆè¡¨æ ¼ä¸Šæ–¹æˆ–ç´€éŒ„ä¸Šæ–¹ï¼‰
    const targetLocation = activePage.querySelector('.table-container') || activePage.querySelector('#logList') || activePage;
    activePage.insertBefore(wrapper, targetLocation);
    
    wrapper.style.display = 'block';
    
    // 4. è¨­å®šæ¨™é¡Œ
    const modeTitle = document.getElementById('scanModeTitle');
    if(mode === 'borrow') modeTitle.innerHTML = `<span style="color:var(--primary)">ğŸ“¤ æ­£åœ¨å€Ÿæ›¸æƒæ...</span>`;
    else if(mode === 'return') modeTitle.innerHTML = `<span style="color:var(--secondary)">ğŸ“¥ æ­£åœ¨é‚„æ›¸æƒæ...</span>`;
    else modeTitle.innerHTML = `<span style="color:var(--dark)">ğŸ” æƒæåœ–æ›¸ QR Code...</span>`;

    // 5. å•Ÿå‹•ç›¸æ©Ÿ
    startScanner();
}

function startScanner() {
    // ç¢ºä¿ä¹‹å‰çš„å¯¦ä¾‹å®Œå…¨æ¸…é™¤
    if (html5QrCode) {
        html5QrCode.clear();
    }
    
    html5QrCode = new Html5Qrcode("reader");
    const scanConfig = { 
        fps: 20, 
        qrbox: { width: 300, height: 300 } 
    };

    html5QrCode.start(
        { facingMode: "environment" }, 
        scanConfig, 
        handleScanSuccess
    ).catch(err => {
        console.error("ç›¸æ©Ÿå•Ÿå‹•å¤±æ•—", err);
        alert("âŒ ç„¡æ³•é–‹å•Ÿç›¸æ©Ÿï¼š\n1. è«‹ç¢ºèªå·²æˆæ¬Šç›¸æ©Ÿæ¬Šé™\n2. å¿…é ˆä½¿ç”¨ HTTPS å®‰å…¨é€£ç·š");
        stopScanner();
    });
}
/*
    function initiateScan(mode) {
        if (mode !== 'manage') {
            const member = document.getElementById('loanMember').value;
            if (!member || member === "(ç„¡æˆå“¡)") {
                alert("âš ï¸ è«‹å…ˆé¸æ“‡å€Ÿé–±äººï¼");
                return;
            }
        }

        currentMode = mode;
        document.getElementById('loanActionGrid').style.display = 'none';
        document.getElementById('manageActionGrid').style.display = 'none';
        
        document.getElementById('reader-wrapper').style.display = 'block';
        
        const modeTitle = document.getElementById('scanModeTitle');
        if(mode === 'borrow') modeTitle.innerHTML = `<span style="color:var(--primary)">ğŸ“¤ æ­£åœ¨å€Ÿæ›¸æƒæ...</span>`;
        else if(mode === 'return') modeTitle.innerHTML = `<span style="color:var(--secondary)">ğŸ“¥ æ­£åœ¨é‚„æ›¸æƒæ...</span>`;
        else modeTitle.innerHTML = `<span style="color:var(--dark)">ğŸ” æƒæåœ–æ›¸ QR Code...</span>`;

        startScanner();
    }

    function startScanner() {
        html5QrCode = new Html5Qrcode("reader");
        const scanConfig = { fps: 20, qrbox: { width: 320, height: 320 } };
        html5QrCode.start({ facingMode: "environment" }, scanConfig, handleScanSuccess)
        .catch(err => {
            alert("ç›¸æ©Ÿé–‹å•Ÿå¤±æ•—ï¼Œè«‹ç¢ºä¿ä½¿ç”¨ HTTPS ç’°å¢ƒ");
            stopScanner();
        });
    }
*/
    function stopScanner() {
        if (html5QrCode) {
            html5QrCode.stop().then(() => {
                html5QrCode = null;
                document.getElementById('reader-wrapper').style.display = 'none';
                document.getElementById('loanActionGrid').style.display = 'grid';
                document.getElementById('manageActionGrid').style.display = 'grid';
            });
        }
    }

    function handleScanSuccess(barcode) {
        if (currentMode === 'manage') {
            stopScanner();
            setTimeout(() => {
                const existing = bookDatabase[barcode] || { title: "", assetId: "" };
                const assetId = prompt("è²¡ç”¢ç·¨è™Ÿ:", existing.assetId || barcode);
                const title = prompt("æ›¸å:", existing.title);
                if (title && assetId) {
                    bookDatabase[barcode] = { title, assetId, count: 0, status: "åœ¨é¤¨" };
                    localStorage.setItem('bookDB', JSON.stringify(bookDatabase));
                    renderBookTable();
                }
            }, 500);
            return;
        }

        if (!bookDatabase[barcode]) { alert("æ‰¾ä¸åˆ°åœ–æ›¸"); stopScanner(); return; }

        const book = bookDatabase[barcode];
        const className = document.getElementById('loanClass').value;
        const userName = document.getElementById('loanMember').value;
        const action = currentMode === 'borrow' ? "å€Ÿæ›¸" : "é‚„æ›¸";

        loanLogs.unshift({ date: new Date().toLocaleString(), className, userName, title: book.title, action });
        book.status = action === "å€Ÿæ›¸" ? `å€Ÿå‡º(${userName})` : "åœ¨é¤¨";

        localStorage.setItem('bookDB', JSON.stringify(bookDatabase));
        localStorage.setItem('loanLogs', JSON.stringify(loanLogs));
        stopScanner();
        alert(`${book.title} ${action}æˆåŠŸ`);
    }

    // --- 4. æ•¸æ“šæ¸²æŸ“èˆ‡ç®¡ç†åŠŸèƒ½ ---
    function addMember() {
        const c = document.getElementById('editClassSelect').value;
        const n = document.getElementById('newMemberName').value.trim();
        if(!n) return;
        if(!members[c]) members[c] = [];
        members[c].push(n);
        localStorage.setItem('memberDB', JSON.stringify(members));
        document.getElementById('newMemberName').value = '';
        renderMemberTable();
    }

    function renderMemberTable() {
        const tbody = document.querySelector('#memberTable tbody');
        tbody.innerHTML = '';
        for(let c in members) {
            members[c].forEach(m => {
                tbody.innerHTML += `<tr><td>${c}</td><td>${m}</td><td><button onclick="deleteMember('${c}','${m}')" style="color:red">åˆªé™¤</button></td></tr>`;
            });
        }
    }

    function deleteMember(c, m) {
        members[c] = members[c].filter(x => x !== m);
        localStorage.setItem('memberDB', JSON.stringify(members));
        renderMemberTable();
    }

    function renderBookTable() {
        const tbody = document.querySelector('#bookTable tbody');
        tbody.innerHTML = Object.keys(bookDatabase).map(barcode => `
            <tr>
                <td>${bookDatabase[barcode].title}</td>
                <td>${bookDatabase[barcode].assetId}</td>
                <td><button onclick="deleteBook('${barcode}')">å ±å»¢</button></td>
            </tr>
        `).join('');
    }

    function deleteBook(id) {
        if(confirm("ç¢ºå®šå ±å»¢ï¼Ÿ")) { delete bookDatabase[id]; localStorage.setItem('bookDB', JSON.stringify(bookDatabase)); renderBookTable(); }
    }

    function renderReportTable() {
        const tbody = document.querySelector('#reportTable tbody');
        tbody.innerHTML = loanLogs.map(log => `<tr><td>${log.date}</td><td>${log.className}</td><td>${log.userName}</td><td>${log.title}</td><td>${log.action}</td></tr>`).join('');
    }

    function updatePassword() {
        const p = document.getElementById('newSystemPwd').value;
        if(p) { config.password = p; localStorage.setItem('libConfig', JSON.stringify(config)); alert("å¯†ç¢¼å·²æ”¹"); }
    }

    function updateClassList() {
        const l = document.getElementById('classListInput').value;
        if(l) { config.classes = l.split(',').map(s=>s.trim()); localStorage.setItem('libConfig', JSON.stringify(config)); initDropdowns(); alert("ç­ç´šæ›´æ–°"); }
    }

    function handleLogout() { location.reload(); }

    initDropdowns();
</script>

</body>
</html>