<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¹¼å…’åœ’åœ–æ›¸è³‡è¨Šç®¡ç†ç³»çµ± Pro (æ¨™ç±¤åˆ—å°ç‰ˆ)</title>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root {
            --primary: #4CAF50;
            --secondary: #2196F3;
            --danger: #f44336;
            --warning: #ff9800;
            --dark: #333;
            --bg: #f4f7f6;
        }
        * { box-sizing: border-box; }
        body { font-family: "å¾®è»Ÿæ­£é»‘é«”", sans-serif; background-color: var(--bg); margin: 0; padding: 10px; }
        .container { max-width: 900px; margin: 10px auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        
        /* å°è¦½åˆ— */
        .nav { display: none; gap: 5px; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 10px; flex-wrap: wrap; }
        .nav button { flex: 1; min-width: 80px; background: #eee; border: none; padding: 12px 5px; cursor: pointer; border-radius: 8px; font-weight: bold; }
        .nav button.active { background: var(--secondary); color: white; }

        .page { display: none; }
        .page.active { display: block; }

        /* ç›¸æ©Ÿå®¹å™¨ */
        #reader-wrapper { display: none; margin: 20px 0; text-align: center; }
        #reader { width: 100%; max-width: 550px; margin: 0 auto; border-radius: 12px; overflow: hidden; border: 5px solid #ccc; }

        /* æƒææ™‚éš±è—å…¶ä»–è³‡è¨Š */
        .scanning-active .input-group, .scanning-active #logList, .scanning-active .action-grid, .scanning-active .table-container, .scanning-active h3 { display: none !important; }

        .action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 15px 0; }
        .btn-main { padding: 20px; border: none; border-radius: 10px; color: white; font-size: 1.1rem; font-weight: bold; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 8px; }
        .btn-borrow { background-color: var(--primary); }
        .btn-return { background-color: var(--secondary); }
        .btn-add-book { background-color: var(--dark); grid-column: span 2; }

        .input-group { margin: 10px 0; display: flex; flex-direction: column; gap: 8px; }
        input, select { padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; width: 100%; }

        table { width: 100%; border-collapse: collapse; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid #eee; }
        
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: bold; color: white; }
        .badge-scrap { background-color: var(--danger); }
        .badge-loaned { background-color: var(--warning); }
        .badge-in { background-color: var(--primary); }

        /* QR æ¨™ç±¤æ’ç‰ˆæ¨£å¼ */
        .qr-label-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; margin-top: 20px; }
        .qr-card { border: 1px solid #ccc; padding: 10px; text-align: center; background: #fff; page-break-inside: avoid; border-radius: 5px; }
        .qr-code-img { display: flex; justify-content: center; margin: 5px 0; }

        @media print {
            .nav, .btn-main, #reader-wrapper, .input-group, .no-print, h2 { display: none !important; }
            .container { box-shadow: none; border: none; width: 100%; max-width: none; margin: 0; padding: 0; }
            .page { display: block !important; }
            .qr-label-grid { grid-template-columns: repeat(3, 1fr); gap: 10px; } /* åˆ—å°æ™‚å›ºå®šä¸‰æ¬„ */
        }
    </style>
</head>
<body>

<div class="container" id="mainContainer">
    <div id="loginPage" class="page active">
        <div style="text-align: center; max-width: 350px; margin: auto;">
            <h2>ğŸ” å¹¼å…’åœ’åœ–æ›¸ç³»çµ±</h2>
            <input type="password" id="loginPwd" placeholder="ç®¡ç†å¯†ç¢¼">
            <button onclick="handleLogin()" class="btn-main btn-return" style="width: 100%; padding: 15px; margin-top: 10px;">ç™»å…¥</button>
        </div>
    </div>

    <div class="nav no-print" id="mainNav">
        <button onclick="changeTab('loanPage')" id="btn-loanPage">å€Ÿé‚„æ›¸</button>
        <button onclick="changeTab('classPage')" id="btn-classPage">ç­ç´šæˆå“¡</button>
        <button onclick="changeTab('managePage')" id="btn-managePage">åœ–æ›¸ç®¡ç†</button>
        <button onclick="changeTab('configPage')" id="btn-configPage">ç³»çµ±è¨­å®š</button>
        <button onclick="changeTab('reportPage')" id="btn-reportPage">å ±è¡¨/åˆ—å°</button>
        <button onclick="handleLogout()" style="background:#666; color:white;">ç™»å‡º</button>
    </div>

    <div id="loanPage" class="page">
        <div class="input-group">
            <select id="loanClass" onchange="filterMembers('loanMember', this.value)"></select>
            <select id="loanMember"></select>
        </div>
        <div id="loanActionGrid" class="action-grid">
            <button onclick="initiateScan('borrow')" class="btn-main btn-borrow">ğŸ“¤ å€Ÿæ›¸</button>
            <button onclick="initiateScan('return')" class="btn-main btn-return">ğŸ“¥ é‚„æ›¸</button>
        </div>
        <div id="reader-wrapper">
            <h3 id="scanModeTitle">æº–å‚™æƒæ...</h3>
            <div id="reader"></div>
            <button onclick="stopScanner()" style="width:100%; padding:15px; margin-top:10px; border-radius:8px; border:none; background:#666; color:white;">âŒ å–æ¶ˆ</button>
        </div>
        <div id="logList"></div>
    </div>

    <div id="classPage" class="page">
        <h3>ğŸ‘¥ ç­ç´šæˆå“¡ç®¡ç†</h3>
        <div class="input-group">
            <select id="editClassSelect"></select>
            <input type="text" id="newMemberName" placeholder="è¼¸å…¥å§“å">
            <button onclick="addMember()" class="btn-main btn-borrow" style="width:100%; padding:10px;">æ–°å¢</button>
        </div>
        <table id="memberTable">
            <thead><tr><th>ç­ç´š</th><th>å§“å</th><th>æ“ä½œ</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>

    <div id="managePage" class="page">
        <div id="manageActionGrid" class="action-grid">
            <button onclick="initiateScan('manage')" class="btn-main btn-add-book">ğŸ” æƒææ–°å¢/å¿«é€Ÿç·¨è¼¯ (QR)</button>
        </div>
        <div class="table-container">
            <table id="bookTable">
                <thead><tr><th>æ›¸å</th><th>è²¡ç”¢ç·¨è™Ÿ</th><th>ç‹€æ…‹</th><th>ç®¡ç†æ“ä½œ</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <div id="configPage" class="page">
        <h3>âš™ï¸ è¨­å®š</h3>
        <div class="input-group">
            <label>ğŸ”‘ ä¿®æ”¹å¯†ç¢¼</label>
            <input type="password" id="newSystemPwd" placeholder="æ–°å¯†ç¢¼">
            <button onclick="updatePassword()" style="background:var(--dark); color:white; padding:10px; border:none; border-radius:5px;">æ›´æ–°</button>
        </div>
        <hr>
        <div class="input-group">
            <label>ğŸ« ç­ç´šæ¸…å–®</label>
            <input type="text" id="classListInput">
            <button onclick="updateClassList()" style="background:var(--secondary); color:white; padding:10px; border:none; border-radius:5px;">æ›´æ–°ç­ç´š</button>
        </div>
    </div>

    <div id="reportPage" class="page">
        <div class="no-print" style="margin-bottom: 20px; display: flex; gap: 10px;">
            <button onclick="window.print()" style="padding:12px; background:#607d8b; color:white; border:none; border-radius:8px; flex:1;">ğŸ–¨ï¸ åˆ—å°ç›®å‰æ¨¡å¼</button>
            <button onclick="togglePrintMode()" id="printModeBtn" style="padding:12px; background:var(--secondary); color:white; border:none; border-radius:8px; flex:1;">åˆ‡æ›è‡³ï¼šæ¨™ç±¤æ¨¡å¼</button>
        </div>

        <div id="logReportSection">
            <h3>ğŸ“Š å€Ÿé–±æ­·å²ç´€éŒ„</h3>
            <table>
                <thead><tr><th>æ™‚é–“</th><th>ç­ç´š</th><th>å§“å</th><th>æ›¸å</th><th>å‹•ä½œ</th></tr></thead>
                <tbody id="reportTableBody"></tbody>
            </table>
        </div>

        <div id="tagReportSection" style="display:none;">
            <h3>ğŸ·ï¸ åœ–æ›¸æ¨™ç±¤åˆ—å° (æ’é™¤å ±å»¢)</h3>
            <div class="qr-label-grid" id="qrLabelContainer"></div>
        </div>
    </div>
</div>

<script>
    // åŸºç¤é‚è¼¯èˆ‡ä¹‹å‰ç‰ˆæœ¬ç›¸åŒ...
    let config = JSON.parse(localStorage.getItem('libConfig')) || { password: "1234", classes: ["å¤ªé™½ç­", "æœˆäº®ç­", "æ˜Ÿæ˜Ÿç­", "å½©è™¹ç­", "ç™½é›²ç­", "å°è‰ç­"] };
    let members = JSON.parse(localStorage.getItem('memberDB')) || {}; 
    let bookDatabase = JSON.parse(localStorage.getItem('bookDB')) || {};
    let loanLogs = JSON.parse(localStorage.getItem('loanLogs')) || [];
    let html5QrCode, currentMode = '';
    let isLabelMode = false; // æ§åˆ¶å ±è¡¨é¡¯ç¤ºæ¨¡å¼

    // --- å ±è¡¨èˆ‡æ¨™ç±¤æ¨¡å¼åˆ‡æ› ---
    function togglePrintMode() {
        isLabelMode = !isLabelMode;
        const logSection = document.getElementById('logReportSection');
        const tagSection = document.getElementById('tagReportSection');
        const btn = document.getElementById('printModeBtn');

        if (isLabelMode) {
            logSection.style.display = 'none';
            tagSection.style.display = 'block';
            btn.innerText = "åˆ‡æ›è‡³ï¼šç´€éŒ„æ¨¡å¼";
            renderQRLabels();
        } else {
            logSection.style.display = 'block';
            tagSection.style.display = 'none';
            btn.innerText = "åˆ‡æ›è‡³ï¼šæ¨™ç±¤æ¨¡å¼";
            renderReportTable();
        }
    }

    function renderQRLabels() {
        const container = document.getElementById('qrLabelContainer');
        container.innerHTML = '';
        
        Object.keys(bookDatabase).forEach(barcode => {
            const book = bookDatabase[barcode];
            if (book.status === "å ±å»¢") return; // å ±å»¢ä¸å°

            const card = document.createElement('div');
            card.className = 'qr-card';
            
            const qrBox = document.createElement('div');
            qrBox.className = 'qr-code-img';
            qrBox.id = `qr-gen-${barcode}`;
            
            card.innerHTML = `<div style="font-size: 13px; font-weight: bold;">${book.title}</div>`;
            card.prepend(qrBox);
            card.innerHTML += `<div style="font-size: 11px; color: #555;">è²¡ç·¨: ${book.assetId}</div>`;
            
            container.appendChild(card);

            // ç”Ÿæˆ QR Code
            new QRCode(document.getElementById(`qr-gen-${barcode}`), {
                text: barcode,
                width: 120,
                height: 120,
                colorDark : "#000000",
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.H
            });
        });
    }

    // --- åŸºç¤æ¡†æ¶å‡½æ•¸ (ç™»å…¥ã€åˆ†é ã€æƒæç­‰) ---
    function handleLogin() {
        if(document.getElementById('loginPwd').value === config.password) {
            document.getElementById('loginPage').classList.remove('active');
            document.getElementById('mainNav').style.display = 'flex';
            initDropdowns();
            changeTab('loanPage');
        } else { alert("å¯†ç¢¼éŒ¯èª¤"); }
    }

    function changeTab(pageId) {
        if (html5QrCode) stopScanner();
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.nav button').forEach(b => b.classList.remove('active'));
        document.getElementById(pageId).classList.add('active');
        document.getElementById('btn-' + pageId).classList.add('active');
        if(pageId === 'classPage') renderMemberTable();
        if(pageId === 'managePage') renderBookTable();
        if(pageId === 'reportPage') {
            isLabelMode = false; 
            togglePrintMode(); togglePrintMode(); // é‡ç½®å›ç´€éŒ„æ¨¡å¼ä¸¦æ›´æ–°
        }
    }

    function renderReportTable() {
        const tbody = document.getElementById('reportTableBody');
        tbody.innerHTML = loanLogs.map(log => `<tr><td>${log.date}</td><td>${log.className}</td><td>${log.userName}</td><td>${log.title}</td><td>${log.action}</td></tr>`).join('');
    }

    // --- å…¶ä»–åŸæœ‰åŠŸèƒ½ä¿æŒä¸è®Š ---
    function initDropdowns() {
        const selects = ['loanClass', 'editClassSelect'];
        selects.forEach(id => {
            const el = document.getElementById(id);
            if(el) el.innerHTML = config.classes.map(c => `<option value="${c}">${c}</option>`).join('');
        });
        document.getElementById('classListInput').value = config.classes.join(',');
        filterMembers('loanMember', config.classes[0]);
    }

    function filterMembers(targetId, className) {
        const el = document.getElementById(targetId);
        const list = members[className] || [];
        el.innerHTML = list.length ? list.map(m => `<option value="${m}">${m}</option>`).join('') : '<option value="">(ç„¡æˆå“¡)</option>';
    }

    function initiateScan(mode) {
        if (mode !== 'manage') { if (!document.getElementById('loanMember').value) { alert("âš ï¸ è«‹å…ˆé¸æ“‡å€Ÿé–±äººï¼"); return; } }
        currentMode = mode;
        document.getElementById('mainContainer').classList.add('scanning-active');
        const wrapper = document.getElementById('reader-wrapper');
        const activePage = document.querySelector('.page.active');
        activePage.prepend(wrapper); 
        wrapper.style.display = 'block';
        startScanner();
    }

    function startScanner() {
        if (html5QrCode) html5QrCode.clear();
        html5QrCode = new Html5Qrcode("reader");
        html5QrCode.start({ facingMode: "environment" }, { fps: 20, qrbox: 300 }, handleScanSuccess).catch(err => { alert("ç›¸æ©Ÿå•Ÿå‹•å¤±æ•—"); stopScanner(); });
    }

    function stopScanner() { if (html5QrCode) html5QrCode.stop().then(() => { html5QrCode = null; document.getElementById('mainContainer').classList.remove('scanning-active'); document.getElementById('reader-wrapper').style.display = 'none'; }); }

    function handleScanSuccess(barcode) {
        if (currentMode === 'manage') {
            stopScanner();
            setTimeout(() => {
                const b = bookDatabase[barcode];
                if(b && b.status === "å ±å»¢") alert("âš ï¸ æ­¤æ›¸å·²å ±å»¢ï¼Œå¦‚éœ€ç·¨è¼¯è«‹å…ˆã€å–æ¶ˆå ±å»¢ã€ã€‚");
                else editBookInfo(barcode);
            }, 300);
            return;
        }
        const book = bookDatabase[barcode];
        if (!book) { alert("âŒ ç„¡æ­¤åœ–æ›¸"); stopScanner(); return; }
        if (book.status === "å ±å»¢") { alert(`âš ï¸ ã€Š${book.title}ã€‹å·²å ±å»¢ï¼Œä¸å¯å€Ÿé‚„ï¼`); stopScanner(); return; }
        const userName = document.getElementById('loanMember').value;
        const className = document.getElementById('loanClass').value;
        if (currentMode === 'borrow') {
            if (book.loanedTo) alert(`âŒ ã€${book.loanedTo}ã€‘å€Ÿé–±ä¸­ã€‚`);
            else { book.loanedTo = userName; book.status = `å€Ÿå‡º(${userName})`; processLoan(book, className, userName, "å€Ÿæ›¸"); }
        } else {
            if (!book.loanedTo) alert(`âŒ æ­¤æ›¸ç›®å‰åœ¨é¤¨å…§ã€‚`);
            else { book.loanedTo = null; book.status = "åœ¨é¤¨"; processLoan(book, className, userName, "é‚„æ›¸"); }
        }
        stopScanner();
    }

    function processLoan(book, className, userName, action) {
        loanLogs.unshift({ date: new Date().toLocaleString(), className, userName, title: book.title, action });
        saveData('bookDB', bookDatabase); saveData('loanLogs', loanLogs);
        renderReportTable();
    }

    function renderBookTable() {
        const tbody = document.querySelector('#bookTable tbody');
        tbody.innerHTML = Object.keys(bookDatabase).map(barcode => {
            const b = bookDatabase[barcode];
            let statusBadge = '', actionButtons = '';
            if(b.status === "å ±å»¢") {
                statusBadge = `<span class="badge badge-scrap">å ±å»¢</span>`;
                actionButtons = `<button onclick="restoreBook('${barcode}')" class="btn-action btn-restore">å–æ¶ˆå ±å»¢</button><button onclick="deleteBook('${barcode}')" class="btn-action btn-del">æ°¸ä¹…åˆªé™¤</button>`;
            } else {
                statusBadge = b.loanedTo ? `<span class="badge badge-loaned">å€Ÿå‡º</span>` : `<span class="badge badge-in">åœ¨é¤¨</span>`;
                actionButtons = `<button onclick="editBookInfo('${barcode}')" class="btn-action btn-edit">ç·¨è¼¯</button><button onclick="scrapBook('${barcode}')" class="btn-action btn-scrap">å ±å»¢</button>`;
            }
            return `<tr><td>${b.title}</td><td>${b.assetId}</td><td>${statusBadge}</td><td>${actionButtons}</td></tr>`;
        }).join('');
    }

    function editBookInfo(barcode) {
        const book = bookDatabase[barcode] || { title: "", assetId: "", status: "åœ¨é¤¨", loanedTo: null };
        const newAssetId = prompt("è²¡ç”¢ç·¨è™Ÿ:", book.assetId || barcode);
        const newTitle = prompt("æ›¸å:", book.title);
        if (newTitle && newAssetId) { bookDatabase[barcode] = { ...book, title: newTitle, assetId: newAssetId }; saveData('bookDB', bookDatabase); renderBookTable(); }
    }

    function scrapBook(id) { if(confirm(`âš ï¸ ç¢ºå®šè¦å°‡ã€Š${bookDatabase[id].title}ã€‹æ¨™è¨˜ç‚ºå ±å»¢ï¼Ÿ`)) { bookDatabase[id].status = "å ±å»¢"; bookDatabase[id].loanedTo = null; saveData('bookDB', bookDatabase); renderBookTable(); } }
    function restoreBook(id) { if(confirm(`ğŸ’¡ ç¢ºå®šè¦æ¢å¾©ã€Š${bookDatabase[id].title}ã€‹ï¼Ÿ`)) { bookDatabase[id].status = "åœ¨é¤¨"; saveData('bookDB', bookDatabase); renderBookTable(); } }
    function deleteBook(id) { if(confirm(`ğŸ”¥ ç¢ºå®šè¦ã€Œæ°¸ä¹…åˆªé™¤ã€ï¼Ÿ`)) { delete bookDatabase[id]; saveData('bookDB', bookDatabase); renderBookTable(); } }
    function addMember() { const c = document.getElementById('editClassSelect').value, n = document.getElementById('newMemberName').value.trim(); if(!n) return; if(!members[c]) members[c] = []; members[c].push(n); saveData('memberDB', members); document.getElementById('newMemberName').value = ''; renderMemberTable(); }
    function renderMemberTable() { const tbody = document.querySelector('#memberTable tbody'); tbody.innerHTML = ''; for(let c in members) members[c].forEach(m => { tbody.innerHTML += `<tr><td>${c}</td><td>${m}</td><td><button onclick="deleteMember('${c}','${m}')" class="btn-action btn-del">åˆªé™¤</button></td></tr>`; }); }
    function deleteMember(c, m) { if(confirm(`ç§»é™¤ã€${c}ã€‘çš„æˆå“¡ã€${m}ã€‘ï¼Ÿ`)) { members[c] = members[c].filter(x => x !== m); saveData('memberDB', members); renderMemberTable(); } }
    function updatePassword() { const p = document.getElementById('newSystemPwd').value; if(p) { config.password = p; saveData('libConfig', config); alert("å¯†ç¢¼æˆåŠŸ"); } }
    function updateClassList() { const l = document.getElementById('classListInput').value; if(l) { config.classes = l.split(',').map(s=>s.trim()); saveData('libConfig', config); initDropdowns(); alert("æ›´æ–°æˆåŠŸ"); } }
    function saveData(key, val) { localStorage.setItem(key, JSON.stringify(val)); }
    function handleLogout() { location.reload(); }
    initDropdowns();
</script>

</body>
</html>